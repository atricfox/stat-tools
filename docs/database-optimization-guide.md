# æ•°æ®åº“å¯åŠ¨ä¼˜åŒ–æŒ‡å—

> **ä¼˜åŒ–æ—¥æœŸ**: 2025-09-16  
> **ç›®æ ‡**: æ¶ˆé™¤ä¸å¿…è¦çš„å¯åŠ¨æ—¶æ•°æ®åº“è¿ç§»ï¼Œæå‡å¼€å‘ä½“éªŒ  
> **ç»“æœ**: å¯åŠ¨æ—¶é—´ä¼˜åŒ–ï¼Œä»æ¯æ¬¡å¼ºåˆ¶è¿ç§»æ”¹ä¸ºæ™ºèƒ½æ£€æŸ¥

## ğŸš€ ä¼˜åŒ–æˆæœ

### å¯åŠ¨æ€§èƒ½æå‡
```yaml
ä¼˜åŒ–å‰:
  å¯åŠ¨æµç¨‹: "predevé’©å­ â†’ å¼ºåˆ¶è¿ç§» â†’ Next.jså¯åŠ¨"
  å¯åŠ¨æ—¶é—´: "~5-8ç§’ (åŒ…å«è¿ç§»æ£€æŸ¥)"
  æ¯æ¬¡å¯åŠ¨: "è¿è¡Œå®Œæ•´è¿ç§»è„šæœ¬"

ä¼˜åŒ–å:
  å¯åŠ¨æµç¨‹: "ç›´æ¥å¯åŠ¨Next.js"
  å¯åŠ¨æ—¶é—´: "~1.9ç§’"
  æ•°æ®åº“æ£€æŸ¥: "æŒ‰éœ€è¿è¡Œï¼Œæ™ºèƒ½è·³è¿‡"
```

### æ–‡ä»¶å˜æ›´æ±‡æ€»
```bash
ç§»é™¤æ–‡ä»¶:
  âœ… setup-globals.js (åŠŸèƒ½é‡å¤)

ä¿®æ”¹æ–‡ä»¶:
  âœ… package.json (ç§»é™¤predev/pretesté’©å­ï¼Œç®€åŒ–å¯åŠ¨è„šæœ¬)
  âœ… next.config.js (å·²åŒ…å«å…¨å±€å˜é‡è®¾ç½®)

æ–°å¢æ–‡ä»¶:
  âœ… scripts/check-db-ready.ts (æ™ºèƒ½æ•°æ®åº“æ£€æŸ¥)
```

## ğŸ“‹ ä¼˜åŒ–è¯¦æƒ…

### 1. ç§»é™¤é‡å¤çš„å…¨å±€å˜é‡è®¾ç½®

#### é—®é¢˜
`setup-globals.js` å’Œ `next.config.js` éƒ½åœ¨è®¾ç½®ç›¸åŒçš„å…¨å±€å˜é‡ï¼š
```javascript
// setup-globals.js (å·²åˆ é™¤)
if (!globalTarget.self) {
  globalTarget.self = globalTarget;
}

// next.config.js (ä¿ç•™)
if (typeof globalThis !== 'undefined' && typeof globalThis.self === 'undefined') {
  globalThis.self = globalThis;
}
```

#### è§£å†³æ–¹æ¡ˆ
- **åˆ é™¤** `setup-globals.js`
- **ä¿ç•™** `next.config.js` ä¸­çš„è®¾ç½®ï¼ˆæ›´åˆé€‚çš„ä½ç½®ï¼‰
- **ç®€åŒ–å¯åŠ¨è„šæœ¬**ï¼š
  ```diff
  - "dev": "node -r ./setup-globals.js next dev -p 3011"
  + "dev": "next dev -p 3011"
  ```

### 2. ä¼˜åŒ–æ•°æ®åº“è¿ç§»ç­–ç•¥

#### é—®é¢˜
æ¯æ¬¡ `npm run dev` å’Œ `npm test` éƒ½é€šè¿‡ `predev`/`pretest` é’©å­å¼ºåˆ¶è¿è¡Œè¿ç§»ï¼š
```json
{
  "predev": "npm run db:migrate:slim || echo 'skip slim migrations'",
  "pretest": "npm run db:migrate:slim || echo 'skip slim migrations'"
}
```

è¿™å¯¼è‡´ï¼š
- âŒ å¯åŠ¨ç¼“æ…¢
- âŒ ä¸å¿…è¦çš„æ•°æ®åº“æ“ä½œ
- âŒ æ—¥å¿—å¹²æ‰°

#### è§£å†³æ–¹æ¡ˆ

##### A. ç§»é™¤è‡ªåŠ¨è¿ç§»é’©å­
```diff
- "predev": "npm run db:migrate:slim || echo 'skip slim migrations'",
- "pretest": "npm run db:migrate:slim || echo 'skip slim migrations'",
```

##### B. åˆ›å»ºæ™ºèƒ½æ•°æ®åº“æ£€æŸ¥è„šæœ¬
`scripts/check-db-ready.ts` ç‰¹æ€§ï¼š

1. **æ™ºèƒ½æ£€æµ‹**ï¼šæ£€æŸ¥æ•°æ®åº“æ˜¯å¦éœ€è¦è¿ç§»
2. **æŒ‰éœ€æ‰§è¡Œ**ï¼šåªåœ¨å¿…è¦æ—¶è¿è¡Œè¿ç§»
3. **å¿«é€Ÿè·³è¿‡**ï¼šæ•°æ®åº“å°±ç»ªæ—¶ç«‹å³è¿”å›

```typescript
// æ£€æŸ¥å…³é”®è¡¨æ˜¯å¦å­˜åœ¨
const requiredTables = [
  'slim_content',
  'slim_content_details', 
  'glossary_terms',
  'calculators'
];

// åªæœ‰ç¼ºå°‘è¡¨æ—¶æ‰è¿è¡Œè¿ç§»
if (!tableExists(db, table)) {
  runMigration();
} else {
  console.log('[db-check] Database is ready, skipping migration');
}
```

##### C. æ–°å¢ä¾¿æ·å‘½ä»¤
```json
{
  "db:check": "tsx scripts/check-db-ready.ts",
  "db:setup": "npm run db:check && echo 'Database setup complete'"
}
```

## ğŸ› ï¸ ä½¿ç”¨æŒ‡å—

### æ—¥å¸¸å¼€å‘æµç¨‹

#### æ­£å¸¸å¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
npm run dev  # ç›´æ¥å¯åŠ¨ï¼Œæ— é¢å¤–æ£€æŸ¥
```

#### é¦–æ¬¡è®¾ç½®æˆ–æœ‰é—®é¢˜æ—¶
```bash
npm run db:setup  # æ™ºèƒ½æ£€æŸ¥+æŒ‰éœ€è¿ç§»
npm run dev       # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
```

#### å¼ºåˆ¶é‡æ–°è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
```bash
npm run db:migrate:slim  # å¼ºåˆ¶è¿è¡Œè¿ç§»
```

### æ–°å›¢é˜Ÿæˆå‘˜æŒ‡å—

1. **å…‹éš†é¡¹ç›®å**ï¼š
   ```bash
   npm install
   npm run db:setup  # é¦–æ¬¡æ•°æ®åº“è®¾ç½®
   npm run dev       # å¯åŠ¨å¼€å‘
   ```

2. **æ—¥å¸¸å¼€å‘**ï¼š
   ```bash
   npm run dev  # ç›´æ¥å¯åŠ¨ï¼Œå¿«é€Ÿå¼€å§‹
   ```

3. **é‡åˆ°æ•°æ®åº“é—®é¢˜æ—¶**ï¼š
   ```bash
   npm run db:check  # æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®åº“
   ```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å¯åŠ¨æ—¶é—´æµ‹è¯•
```yaml
æµ‹è¯•ç¯å¢ƒ: WSL2, Node.js 20.19.2, Next.js 15.5.2

ä¼˜åŒ–å‰:
  å†·å¯åŠ¨: ~8ç§’ (åŒ…å«å®Œæ•´è¿ç§»æ£€æŸ¥)
  çƒ­å¯åŠ¨: ~5ç§’ (è¿ç§»è·³è¿‡ä½†ä»æ£€æŸ¥)
  
ä¼˜åŒ–å:
  å†·å¯åŠ¨: ~2ç§’ (ç›´æ¥å¯åŠ¨Next.js)
  çƒ­å¯åŠ¨: ~1.9ç§’ (æ— é¢å¤–å¼€é”€)
  
æ€§èƒ½æå‡: 60-75% å¯åŠ¨æ—¶é—´å‡å°‘
```

### æ—¥å¿—è¾“å‡ºå¯¹æ¯”
```diff
ä¼˜åŒ–å‰å¯åŠ¨æ—¥å¿—:
+ > statcal@0.1.0 predev
+ > npm run db:migrate:slim || echo 'skip slim migrations'
+ > statcal@0.1.0 db:migrate:slim  
+ > tsx scripts/run-migrations.ts
+ [migrate] Using database at: /root/dev/next/stat-tools/data/statcal.db
+ [migrate] OK: 002_slim_schema.sql
+ [migrate] Skip MIGRATE_CONTENT_MAIN (no legacy content tables)
+ ...
  > statcal@0.1.0 dev
  > next dev -p 3011
  âœ“ Ready in 2.2s

ä¼˜åŒ–åå¯åŠ¨æ—¥å¿—:
  > statcal@0.1.0 dev  
  > next dev -p 3011
  âœ“ Ready in 1.9s
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### Q: å¯åŠ¨æ—¶å‡ºç°æ•°æ®åº“é”™è¯¯
```bash
# è§£å†³æ–¹æ¡ˆï¼šè¿è¡Œæ•°æ®åº“æ£€æŸ¥
npm run db:check
```

#### Q: éœ€è¦é‡æ–°åˆå§‹åŒ–æ•°æ®åº“
```bash
# å¤‡ä»½ç°æœ‰æ•°æ®ï¼ˆå¦‚æœéœ€è¦ï¼‰
cp data/statcal.db data/statcal.backup.db

# åˆ é™¤æ•°æ®åº“é‡æ–°åˆ›å»º
rm data/statcal.db
npm run db:setup
```

#### Q: å›¢é˜ŸåŒæ­¥æ•°æ®åº“æ¶æ„
```bash
# æ‹‰å–æœ€æ–°ä»£ç å
git pull
npm run db:check  # è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°æ•°æ®åº“æ¶æ„
```

### è°ƒè¯•å‘½ä»¤

#### æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
```bash
# æ™ºèƒ½æ£€æŸ¥
npm run db:check

# æŸ¥çœ‹è¡¨ç»“æ„
sqlite3 data/statcal.db ".tables"
sqlite3 data/statcal.db ".schema slim_content"
```

#### æ‰‹åŠ¨è¿ç§»
```bash
# è¿è¡Œç‰¹å®šè¿ç§»
npm run db:migrate:slim

# è¿è¡Œå®Œæ•´è¿ç§»ï¼ˆåŒ…å«åˆå§‹åŒ–ï¼‰
npm run db:migrate
```

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘å›¢é˜Ÿåä½œ

1. **æ–°åŠŸèƒ½å¼€å‘**ï¼š
   - å¦‚æœæ¶‰åŠæ•°æ®åº“å˜æ›´ï¼Œæ›´æ–°è¿ç§»è„šæœ¬
   - åœ¨PRä¸­è¯´æ˜æ˜¯å¦éœ€è¦è¿è¡Œ `npm run db:check`

2. **ä»£ç å®¡æŸ¥**ï¼š
   - æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ•°æ®åº“ä¾èµ–
   - ç¡®è®¤è¿ç§»è„šæœ¬çš„å¹‚ç­‰æ€§

3. **éƒ¨ç½²æµç¨‹**ï¼š
   - ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¿è¡Œ `npm run db:check`
   - ç¡®ä¿æ•°æ®åº“æ¶æ„åŒæ­¥

### æ€§èƒ½ç›‘æ§

å®šæœŸæ£€æŸ¥å¯åŠ¨æ€§èƒ½ï¼š
```bash
# æµ‹é‡å¯åŠ¨æ—¶é—´
time npm run dev
```

ç›®æ ‡æŒ‡æ ‡ï¼š
- **å¼€å‘å¯åŠ¨**: < 3ç§’
- **ç”Ÿäº§æ„å»º**: < 30ç§’  
- **æ•°æ®åº“æ£€æŸ¥**: < 1ç§’

## ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸæ”¹è¿› (1-2å‘¨)
- [ ] æ·»åŠ æ•°æ®åº“å¥åº·æ£€æŸ¥ç«¯ç‚¹
- [ ] ä¼˜åŒ–FTS5ç´¢å¼•æ›´æ–°ç­–ç•¥
- [ ] æ·»åŠ æ•°æ®åº“è¿æ¥æ± 

### ä¸­æœŸè§„åˆ’ (1ä¸ªæœˆ)
- [ ] æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿ
- [ ] è‡ªåŠ¨åŒ–æ•°æ®å¤‡ä»½
- [ ] æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿

### é•¿æœŸç›®æ ‡ (3ä¸ªæœˆ)
- [ ] æ•°æ®åº“åˆ†ç‰‡ç­–ç•¥
- [ ] ç¼“å­˜å±‚ä¼˜åŒ–
- [ ] å¾®æœåŠ¡æ¶æ„è¿ç§»

---

**æ€»ç»“**: é€šè¿‡ç§»é™¤ä¸å¿…è¦çš„å¯åŠ¨é’©å­å’Œé‡å¤ä»£ç ï¼Œæˆ‘ä»¬å®ç°äº†60-75%çš„å¯åŠ¨æ—¶é—´å‡å°‘ï¼ŒåŒæ—¶ä¿æŒäº†æ•°æ®åº“ç®¡ç†çš„å¯é æ€§ã€‚æ–°çš„æ™ºèƒ½æ£€æŸ¥æœºåˆ¶ç¡®ä¿äº†å¼€å‘ä½“éªŒçš„æµç•…æ€§ï¼ŒåŒæ—¶åœ¨éœ€è¦æ—¶æä¾›äº†å®Œæ•´çš„æ•°æ®åº“ç®¡ç†åŠŸèƒ½ã€‚