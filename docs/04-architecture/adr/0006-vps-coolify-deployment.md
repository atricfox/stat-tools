# ADR-0006: VPS + Coolify部署决策

## 状态
Accepted

## 背景

Stat Tools 项目需要重新评估部署策略，基于以下变化：

1. **成本控制需求**：希望有可预测的成本结构，避免按使用量付费的不确定性
2. **完全控制**：需要对部署环境有完全的控制权，避免供应商锁定
3. **简化架构**：初期不需要复杂的边缘计算和全球分发，专注于核心功能
4. **运维效率**：虽然要自主控制，但希望有简化的部署和管理体验
5. **技术栈统一**：使用单一技术栈（Next.js全栈）减少复杂性

## 决策

我们选择 **VPS + Coolify** 作为主要部署平台，具体包括：

### 核心组件
- **VPS服务器** - 提供计算和存储资源
- **Coolify平台** - 简化的PaaS体验，运行在自己的服务器上
- **Docker容器化** - 应用运行环境
- **Nginx/Traefik** - 反向代理和SSL终结
- **Let's Encrypt** - 自动SSL证书管理

### 技术架构
- **Next.js全栈应用** - 前端和API统一在一个应用中
- **本地文件存储** - 临时导出文件存储在容器本地
- **定期清理任务** - 自动清理过期的临时文件
- **简化监控** - 使用Coolify内置监控和Docker日志

### 部署流程
```
开发 → GitHub → Coolify Webhook → Docker构建 → 容器部署 → 健康检查
```

## 后果

### 积极后果

1. **成本可控**：
   - VPS固定成本，可预测的月度支出
   - 无需按请求量或数据传输付费
   - 可根据实际需求选择合适规格的服务器

2. **完全控制**：
   - 服务器完全控制权，无供应商锁定
   - 可以随时迁移到其他提供商
   - 灵活的配置和扩展选项

3. **运维简化**：
   - Coolify提供类似PaaS的体验
   - 自动Docker化和部署
   - 内置SSL证书管理和反向代理
   - 简单的监控和日志管理

4. **技术栈统一**：
   - Next.js处理前端和API，减少技术复杂度
   - 单一代码库，easier维护和开发
   - TypeScript全栈类型安全

5. **开发效率**：
   - Git push即部署的简单流程
   - 预览环境和生产环境一致
   - 快速的本地到生产的开发循环

### 消极后果

1. **运维责任**：
   - 需要管理服务器的安全更新和维护
   - 备份和灾难恢复需要自己配置
   - 需要基本的Linux服务器管理知识

2. **扩展限制**：
   - 单服务器的性能上限
   - 地理分布需要额外的CDN配置
   - 高可用需要多服务器架构

3. **功能限制**：
   - 没有边缘计算的低延迟优势
   - 文件存储依赖本地磁盘空间
   - 需要手动配置缓存策略

4. **学习曲线**：
   - 团队需要熟悉Coolify平台
   - Docker容器化的概念和最佳实践
   - 基本的服务器运维知识

## 考虑的选项

### 选项1：继续Cloudflare Pages + Workers
**优势**：
- 全球边缘分发，性能优异
- 自动扩缩容
- 丰富的边缘计算功能

**劣势**：
- 成本难以预测
- 供应商锁定严重
- 架构复杂度高
- 学习曲线陡峭

**评估**：不适合当前需要成本控制和架构简化的需求

### 选项2：传统云服务商（AWS/GCP/Azure）
**优势**：
- 功能最全面
- 企业级可靠性
- 丰富的配套服务

**劣势**：
- 成本高且复杂
- 配置复杂，学习成本高
- 容易产生意外费用

**评估**：对初期项目过于复杂和昂贵

### 选项3：Vercel
**优势**：
- Next.js原生支持
- 优秀的开发者体验
- 自动优化和部署

**劣势**：
- 成本在规模后较高
- 功能限制较多
- 仍然是供应商锁定

**评估**：成本模式不符合需求，功能限制较多

### 选项4：传统VPS手动配置
**优势**：
- 完全控制
- 成本最低
- 高度可定制

**劣势**：
- 运维负担极重
- 配置复杂容易出错
- 缺少现代化的部署工具

**评估**：运维负担过重，不适合快速开发

## 决策标准

基于以下标准进行评估：

| 标准 | 权重 | VPS+Coolify | Cloudflare | AWS | Vercel | 手动VPS |
|------|------|-------------|------------|-----|---------|----------|
| 成本可控性 | 25% | 10 | 5 | 4 | 6 | 10 |
| 运维复杂度 | 20% | 8 | 9 | 4 | 9 | 2 |
| 开发效率 | 20% | 8 | 7 | 5 | 10 | 3 |
| 完全控制 | 15% | 9 | 3 | 6 | 4 | 10 |
| 扩展灵活性 | 10% | 7 | 8 | 10 | 6 | 8 |
| 技术简化 | 10% | 9 | 6 | 5 | 8 | 4 |

**最终得分**：
- VPS + Coolify: 8.5
- Cloudflare: 6.4
- AWS: 5.2
- Vercel: 7.1
- 手动VPS: 5.4

## 实施策略

### 第一阶段：基础部署（1-2周）
1. **服务器准备**：
   - 选择VPS提供商并配置服务器
   - 安装和配置Coolify
   - 配置域名和DNS

2. **应用容器化**：
   - 编写Dockerfile
   - 配置Next.js生产构建
   - 设置环境变量

3. **部署配置**：
   - 连接GitHub仓库
   - 配置自动部署
   - 设置SSL证书

### 第二阶段：优化和监控（2-3周）
1. **性能优化**：
   - 配置反向代理缓存
   - 优化Docker镜像大小
   - 设置文件清理任务

2. **监控告警**：
   - 配置健康检查
   - 设置资源使用监控
   - 建立基本的告警机制

3. **备份策略**：
   - 配置数据备份
   - 建立恢复流程
   - 测试灾难恢复

### 第三阶段：扩展准备（按需）
1. **性能扩展**：
   - 评估CDN需求
   - 配置数据库（如需要）
   - 负载均衡（多实例）

2. **监控升级**：
   - 集成外部监控服务
   - 详细的性能指标
   - 用户体验监控

## 风险缓解

### 单点故障风险
- **缓解策略**：
  - 选择可靠的VPS提供商
  - 配置自动备份
  - 建立快速恢复流程
  - 监控服务可用性

### 性能限制风险
- **缓解策略**：
  - 优化代码和资源
  - 配置合理的缓存策略
  - 准备CDN集成方案
  - 监控性能指标

### 运维知识风险
- **缓解策略**：
  - 团队学习基本运维知识
  - 建立详细的操作文档
  - 建立紧急联系流程
  - 考虑外部支持服务

### 扩展限制风险
- **缓解策略**：
  - 使用可扩展的架构设计
  - 准备迁移到更强服务器的计划
  - 保持代码的云原生友好
  - 定期评估扩展需求

## 成功指标

### 技术指标
- **部署成功率** > 95%
- **平均部署时间** < 5分钟
- **服务可用性** > 99.5%
- **页面响应时间** < 2秒

### 业务指标
- **月度运营成本**：固定且在预算内
- **开发部署频率**：每日多次部署
- **问题解决时间**：平均 < 2小时
- **团队满意度**：运维负担可接受

### 用户指标
- **页面加载速度**：Core Web Vitals达标
- **功能可用性**：所有计算器正常工作
- **文件导出**：成功率 > 98%

## 后续评估

计划每季度评估部署策略的效果：

### 评估内容
- **成本效益**：实际费用vs预期预算
- **性能表现**：响应时间、可用性指标
- **运维负担**：时间投入、问题频率
- **扩展需求**：用户增长、功能需求变化

### 调整触发条件
- 月活用户超过10,000时考虑CDN
- 响应时间持续 > 3秒时优化或扩容
- 运维问题频发时考虑托管服务
- 成本优势消失时重新评估选项

## 相关决策
- [ADR-0001: UI技术栈选择](0001-ui-technology-stack.md) - 前端技术选择

## 迁移计划

### 从Cloudflare迁移（如适用）
1. **代码适配**：
   - 移除Workers特定代码
   - 转换为Next.js API Routes
   - 更新环境变量

2. **数据迁移**：
   - R2存储数据迁移到本地存储
   - 更新文件访问逻辑
   - 测试导出功能

3. **DNS切换**：
   - 更新DNS记录指向新服务器
   - 配置SSL证书
   - 验证所有功能正常

### 回退计划
如果VPS方案出现重大问题：
- 保持原有代码分支可快速回退
- 维护两套部署配置的兼容性
- 建立快速切换DNS的流程

---

**作者**：架构团队  
**日期**：2025-09-05  
**审查者**：开发团队、产品团队