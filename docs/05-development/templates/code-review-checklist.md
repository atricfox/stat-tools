# 代码审查清单模板

## 🎯 概述

基于 Linus 工程哲学的代码审查清单，确保代码质量符合"Given enough eyeballs, all bugs are shallow"的理念。

**适用范围**: 所有 Pull Request 和代码提交  
**执行标准**: 必须至少 2 人审查通过才能合并  
**审查时限**: 工作日内 24 小时内完成初审

---

## 🐧 Linus 哲学指导原则

### "Show me the code" - 实证审查
- 审查关注实际代码实现，不接受"理论上可行"的说明
- 要求代码有对应的测试证明功能正确性
- 性能声明必须有 benchmark 数据支撑
- 架构改进必须有具体代码体现

### "Perfect is achieved when nothing left to take away" - 简洁性审查
- 优先审查是否可以删除代码而不是添加代码
- 检查是否存在过度设计和不必要的复杂性
- 确保新增代码确实解决了现实问题
- 验证接口和抽象保持最小必要集

### "Given enough eyeballs, all bugs are shallow" - 集体智慧
- 鼓励多角度审查，不同背景的审查者提供不同视角
- 建设性讨论，关注代码改进而非个人批评
- 审查过程透明，相关讨论对团队可见
- 经验分享，将审查过程作为知识传递机会

---

## 📋 代码审查清单

### 🔍 基础检查 (强制项)

#### PR 基本信息
- [ ] **标题清晰**: PR 标题准确描述变更内容 (≤50字符)
- [ ] **描述完整**: PR 描述包含变更原因、实现方案、测试方法
- [ ] **关联工作项**: 链接到相应的用户故事或任务
- [ ] **变更范围合理**: 单个 PR 变更文件数 ≤20，行数 ≤500

#### 代码基础质量
- [ ] **编译通过**: 代码能够成功编译，无语法错误
- [ ] **lint 通过**: 通过 ESLint/golangci-lint 等代码规范检查
- [ ] **类型检查**: TypeScript/Go 类型检查通过
- [ ] **格式正确**: 代码格式符合团队约定 (Prettier/gofmt)

### 🧪 测试完整性审查

#### TDD 实践检查
- [ ] **测试优先**: 重要功能有对应的测试用例
- [ ] **测试覆盖**: 新增代码测试覆盖率 ≥90%
- [ ] **测试质量**: 测试用例有意义，非为了覆盖率而写
- [ ] **边界测试**: 包含边界条件和异常情况测试
- [ ] **测试独立**: 测试用例之间相互独立，可并发执行

```yaml
# 测试检查标准
test_requirements:
  unit_tests: "所有新增函数都有单元测试"
  integration_tests: "API 端点有集成测试"
  e2e_tests: "关键用户流程有端到端测试"
  performance_tests: "性能敏感功能有性能测试"
```

#### 测试代码质量
- [ ] **测试命名**: 测试名称清楚说明测试场景
- [ ] **AAA 模式**: 遵循 Arrange-Act-Assert 模式
- [ ] **测试数据**: 使用合理的测试数据，避免硬编码
- [ ] **清理资源**: 测试后正确清理创建的资源

### 🏗️ 代码设计和架构审查

#### 设计原则检查
- [ ] **单一职责**: 每个函数/类职责单一且明确
- [ ] **开闭原则**: 对扩展开放，对修改关闭
- [ ] **接口分离**: 接口定义最小且内聚
- [ ] **依赖倒置**: 依赖抽象而非具体实现

#### 代码组织
- [ ] **文件结构**: 文件组织逻辑清晰，命名一致
- [ ] **模块化**: 代码模块化程度合适，职责清晰
- [ ] **重复代码**: 无明显重复代码，公共逻辑已提取
- [ ] **命名规范**: 变量、函数、类名称具有语义性

### 🔒 安全性审查

#### 基础安全检查
- [ ] **输入验证**: 所有外部输入都经过验证
- [ ] **SQL 注入**: 使用参数化查询，无 SQL 注入风险
- [ ] **XSS 防护**: 前端输出经过适当转义
- [ ] **认证授权**: 权限检查正确实现
 - [ ] **CSP/Nonce 合规**: 无内联脚本滥用；所有脚本通过 `next/script` 且携带 `nonce`；CSP 报告无阻断性违例
 - [ ] **安全响应头**: `X-Content-Type-Options`、`Referrer-Policy`、`X-Frame-Options`、`Permissions-Policy` 配置正确
 - [ ] **第三方脚本治理**: 第三方源最小白名单化，新增域名需安全评审

#### 敏感信息检查
- [ ] **密钥管理**: 无硬编码密钥和敏感信息
- [ ] **日志安全**: 日志中无敏感信息泄露
- [ ] **错误处理**: 错误信息不暴露系统内部细节
- [ ] **数据脱敏**: 敏感数据显示时进行脱敏

### ⚡ 性能和效率审查

#### 性能考虑
- [ ] **算法效率**: 算法时间复杂度合理
- [ ] **数据库查询**: 避免 N+1 查询问题
- [ ] **缓存策略**: 适当使用缓存提高性能
- [ ] **资源管理**: 正确管理内存、文件句柄等资源

#### 前端性能 (如适用)
- [ ] **bundle 大小**: 避免引入不必要的大型依赖
- [ ] **懒加载**: 适当使用懒加载和代码分割
- [ ] **图片优化**: 图片格式和大小合理
- [ ] **网络请求**: 减少不必要的网络请求

### 📚 文档和可维护性

#### 代码可读性
- [ ] **注释质量**: 复杂逻辑有适当注释说明
- [ ] **自文档化**: 代码本身具有良好的可读性
- [ ] **变量名**: 变量和函数名称表意明确
- [ ] **代码结构**: 代码结构清晰，逻辑流程易懂

#### 文档更新
- [ ] **API 文档**: 新增/修改的 API 有对应文档
- [ ] **README 更新**: 影响使用的变更更新了 README
- [ ] **架构文档**: 架构变更更新了相关文档
- [ ] **变更日志**: 重要变更记录到 CHANGELOG

### 🔗 集成和兼容性

#### 向后兼容性
- [ ] **API 兼容**: API 变更保持向后兼容
- [ ] **数据库兼容**: 数据库 schema 变更有迁移脚本
- [ ] **配置兼容**: 配置文件变更考虑了兼容性
- [ ] **依赖兼容**: 依赖版本变更经过兼容性验证

#### 集成测试
- [ ] **CI 通过**: 所有 CI 检查都通过
- [ ] **部署验证**: 在测试环境成功部署和验证
- [ ] **回滚测试**: 确认可以安全回滚 (如适用)
- [ ] **监控告警**: 新功能有适当的监控和告警

---

## 📊 代码审查评分标准

### 评分维度
```yaml
review_scoring:
  functionality: 
    weight: 30%
    criteria: "功能正确性、需求满足度"
    
  code_quality:
    weight: 25%
    criteria: "代码规范、可读性、可维护性"
    
  testing:
    weight: 20%
    criteria: "测试覆盖率、测试质量"
    
  security:
    weight: 15%
    criteria: "安全漏洞、敏感信息处理"
    
  performance:
    weight: 10%
    criteria: "性能影响、资源使用"
```

### 通过标准
- **必须通过**: 所有强制检查项 (🔍 基础检查) 100% 通过
- **建议通过**: 其他检查项 ≥80% 通过
- **审查人数**: 至少 2 人审查，1 人必须是高级开发者
- **审查时间**: 复杂 PR 允许 48 小时审查期

---

## 🚦 审查流程和角色

### 审查角色定义

#### 主审查人 (Primary Reviewer)
**职责**:
- [ ] 负责整体代码质量把关
- [ ] 审查架构设计和实现方案
- [ ] 最终决定是否通过审查

**要求**:
- 高级开发者或技术负责人
- 对相关模块和技术栈熟悉
- 有丰富的代码审查经验

#### 辅助审查人 (Secondary Reviewer)
**职责**:
- [ ] 从不同角度审查代码
- [ ] 关注细节实现和潜在问题
- [ ] 提供建设性改进建议

**要求**:
- 中级或以上开发者
- 对项目和业务逻辑熟悉
- 有良好的沟通能力

### 审查流程

#### 第一阶段: 自审 (Self Review)
**提交者自检清单**:
- [ ] 运行所有测试，确保通过
- [ ] 运行 lint 和格式化工具
- [ ] 审查自己的代码变更
- [ ] 更新相关文档
- [ ] 填写完整的 PR 描述

#### 第二阶段: 同行审查 (Peer Review)
**审查时间**: 24-48 小时内  
**审查方式**: 
- [ ] 在线代码审查 (GitHub PR Review)
- [ ] 必要时进行面对面讨论
- [ ] 复杂变更可安排代码走查会议

**审查输出**:
- [ ] 通过/拒绝决定
- [ ] 具体改进建议
- [ ] 学习要点分享

#### 第三阶段: 改进迭代
**改进原则**:
- [ ] 及时响应审查反馈
- [ ] 逐项解决提出的问题
- [ ] 不明确的问题及时沟通澄清
- [ ] 重新提交后通知审查人

---

## 📝 审查记录模板

### 审查意见格式

```markdown
## 代码审查报告 - PR #[编号]

### 基本信息
- **审查人**: [姓名]
- **审查日期**: [YYYY-MM-DD]
- **审查耗时**: [XX 分钟]
- **代码规模**: [文件数/行数]

### 整体评价
- **功能正确性**: ⭐⭐⭐⭐⭐ (5/5)
- **代码质量**: ⭐⭐⭐⭐☆ (4/5)
- **测试完整性**: ⭐⭐⭐⭐⭐ (5/5)
- **文档完整性**: ⭐⭐⭐☆☆ (3/5)

### 具体问题和建议

#### 🚨 必须修改 (Blocking Issues)
1. **安全问题** (文件: `src/auth.ts:45`)
   - **问题**: 用户输入未进行验证
   - **建议**: 添加输入验证中间件
   - **影响**: 存在注入攻击风险

#### ⚠️ 建议改进 (Suggestions)
1. **性能优化** (文件: `src/api/users.ts:123`)
   - **问题**: 数据库查询可能产生 N+1 问题
   - **建议**: 使用 JOIN 或预加载优化查询
   - **影响**: 大数据量时性能下降

#### 💡 改进建议 (Nice to Have)
1. **代码可读性** (文件: `src/utils/helper.ts:67`)
   - **建议**: 函数名可以更具描述性
   - **推荐**: `processUserData` → `validateAndTransformUserData`

### 学习要点
- **优秀实践**: 测试用例设计很全面，边界条件考虑充分
- **技术亮点**: 使用了合适的设计模式，代码结构清晰
- **知识分享**: 新的工具库使用方法值得团队学习

### 最终决定
- [ ] ✅ **批准** - 代码质量符合标准，可以合并
- [ ] ❌ **拒绝** - 存在必须解决的问题
- [ ] 🔄 **有条件批准** - 解决标记问题后可合并
```

---

## 📈 审查质量度量

### 审查效果指标

```yaml
review_metrics:
  review_coverage: "PR 审查覆盖率 (≥ 100%)"
  review_time: "平均审查时间 (≤ 24小时)"
  defect_detection: "审查阶段缺陷发现率 (≥ 80%)"
  feedback_quality: "审查意见有效性评分 (≥ 4.0/5.0)"
  
quality_outcomes:
  production_defects: "生产环境缺陷率 (≤ 2%)"
  rework_rate: "返工率 (≤ 10%)"
  code_maintainability: "代码可维护性评分 (≥ 8.0/10)"
  team_satisfaction: "团队审查流程满意度 (≥ 4.0/5.0)"
```

### 持续改进机制

#### 每周审查总结
- [ ] **审查统计**: 审查数量、通过率、平均时间
- [ ] **问题分析**: 常见问题类型和频率分析
- [ ] **最佳实践**: 发现的优秀代码实践分享
- [ ] **流程改进**: 审查流程的改进建议

#### 月度审查回顾
- [ ] **质量趋势**: 代码质量指标趋势分析
- [ ] **团队成长**: 审查技能提升情况
- [ ] **工具改进**: 审查工具和流程优化
- [ ] **培训计划**: 基于审查发现的培训需求

---

## 🛠️ 审查工具和技术

### 自动化审查工具

#### 静态代码分析
```yaml
frontend_tools:
  - "ESLint: 代码规范检查"
  - "Prettier: 代码格式化"
  - "TypeScript: 类型检查"
  - "SonarQube: 代码质量分析"

backend_tools:
  - "golangci-lint: Go 代码规范"
  - "gofmt: Go 代码格式化"
  - "go vet: Go 静态分析"
  - "Semgrep: 安全漏洞扫描"
```

#### CI 集成检查
```yaml
ci_checks:
  - "单元测试执行和覆盖率检查"
  - "集成测试执行"
  - "安全漏洞扫描"
  - "性能回归测试"
  - "构建和部署验证"
```

### 手工审查最佳实践

#### 审查技巧
- [ ] **从小到大**: 先看整体结构，再看具体实现
- [ ] **关注变更**: 重点审查变更的代码，而非整个文件
- [ ] **考虑上下文**: 理解代码变更的业务背景
- [ ] **注意依赖**: 检查变更对其他模块的影响

#### 沟通技巧
- [ ] **建设性反馈**: 专注于代码改进，避免个人攻击
- [ ] **具体建议**: 提供具体的改进建议，不只是指出问题
- [ ] **及时沟通**: 复杂问题及时面对面或视频沟通
- [ ] **知识分享**: 将审查过程作为知识传递机会

---

## 📚 审查培训和提升

### 审查技能培训

#### 新员工审查培训
- [ ] **审查流程**: 理解审查流程和工具使用
- [ ] **审查标准**: 学习审查检查清单和质量标准
- [ ] **沟通技巧**: 掌握有效的审查反馈技巧
- [ ] **实践指导**: 在资深人员指导下完成首次审查

#### 高级审查技能
- [ ] **架构审查**: 评估设计决策和架构影响
- [ ] **性能审查**: 识别性能瓶颈和优化机会
- [ ] **安全审查**: 发现安全漏洞和风险点
- [ ] **可维护性审查**: 评估代码的长期可维护性

### 审查质量提升

#### 个人提升计划
- [ ] **审查记录**: 记录审查过程和发现的问题
- [ ] **反馈收集**: 收集被审查人对审查质量的反馈
- [ ] **持续学习**: 学习新的审查技术和最佳实践
- [ ] **经验分享**: 在团队内分享审查经验和技巧

#### 团队提升活动
- [ ] **审查分享会**: 定期分享优秀审查案例
- [ ] **代码走查**: 针对复杂功能组织集体代码走查
- [ ] **审查竞赛**: 开展代码审查质量评比活动
- [ ] **外部学习**: 参与行业代码审查最佳实践交流

---

**模板版本**: v1.0  
**创建日期**: 2024-08-28  
**适用项目**: ClinWise EDC  
**维护团队**: 开发团队 + 质量保证团队

**Linus 哲学体现**:
- ✅ "Show me the code" - 实证为主的审查方式
- ✅ "Perfect is achieved when nothing left to take away" - 优先审查简化
- ✅ "Given enough eyeballs, all bugs are shallow" - 多人集体审查
- ✅ "Good programmers know what to rewrite" - 建设性改进建议
- ✅ "Release early, release often" - 快速审查反馈循环
