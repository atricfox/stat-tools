# 系统总览架构

id: ARCH-OVERVIEW-001
---
id: ARCH-OVERVIEW-001
owner: @product-owner
acceptance: docs/03-acceptance/04-architecture.feature
version: 2.0
created: 2025-09-05
updated: 2025-09-05
status: Updated
reviewers: []
---

## 目的

本文档提供 Stat Tools 系统的全景架构视图，基于VPS + Coolify的简化部署方案，整合前端UI、后端API、部署环境和数据流，为团队提供统一的技术决策参考。

## 系统架构图（简化版）

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                 │
├─────────────────────────────────────────────────────────────┤
│  Web Browser (Desktop/Mobile)  │  Search Engines (SEO)      │
└─────────────────┬───────────────┴─────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│                    VPS + Coolify                           │
│  • 反向代理       • SSL终结       • 域名管理                  │
│  • Docker容器管理 • 环境变量     • 健康监控                   │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│                 Next.js 全栈应用                            │
│  ┌─────────────────────────────────────────────────────────┐│
│  │            前端 + API Routes                            ││
│  │  • SSG/SSR页面     • React组件    • Tailwind样式        ││
│  │  • API计算逻辑     • 文件导出     • 状态管理             ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│                   本地文件系统                               │
│  • 临时导出文件   • 定期自动清理   • Token验证访问           │
└─────────────────┬───────────────────────────────────────────┘
                  │
┌─────────────────┴───────────────────────────────────────────┐
│                   运维监控                                   │
│  • Docker容器日志 • Coolify监控面板 • 健康检查              │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈总览

### 前端层
| 组件 | 技术选择 | 版本 | 作用 |
|------|----------|------|------|
| 框架 | Next.js | 15.x | SSR/SSG、路由、API Routes |
| UI库 | React | 19.x | 组件化开发 |
| 样式 | Tailwind CSS | 3.x | 原子化CSS、响应式设计 |
| 组件库 | Headless UI + 自定义 | 最新 | 无头组件、可访问性 |
| 状态管理 | React Hook + Zustand | - | 本地状态 + 轻量全局状态 |
| 表单 | React Hook Form + Zod | 最新 | 表单验证、类型安全 |
| 图标 | Heroicons | 2.x | 一致的图标体系 |

### 后端层（简化）
| 组件 | 技术选择 | 版本 | 作用 |
|------|----------|------|------|
| 运行时 | Node.js | 20.x | 服务端运行环境 |
| API | Next.js API Routes | 15.x | RESTful API端点 |
| 计算逻辑 | TypeScript | 5.x | 统计计算、数据验证 |
| 文件存储 | 本地文件系统 | - | 临时导出文件存储 |
| 会话管理 | 无状态Token | - | 文件访问控制 |
| 清理任务 | Cron Jobs | - | 定期文件清理 |

### 基础设施层（简化）
| 组件 | 技术选择 | 版本 | 作用 |
|------|----------|------|------|
| 容器化 | Docker | 最新 | 应用容器化 |
| 部署平台 | Coolify | 最新 | 应用部署管理 |
| 服务器 | VPS | - | 计算资源 |
| 反向代理 | Nginx/Traefik | - | 请求路由、SSL终结 |
| 监控 | Coolify监控 + Docker日志 | - | 系统监控、日志管理 |

## 数据流架构

### 1. 页面访问流程（简化）
```
用户请求 → VPS/反向代理 → Next.js(SSG/SSR) → HTML响应 → 客户端渲染
```

### 2. 计算处理流程
```
用户输入 → 客户端验证 → 本地计算 → 结果展示
           ↓(可选)
         API验证 → Next.js API计算 → 结果返回
```

### 3. 导出文件流程（简化）  
```
导出请求 → Next.js API处理 → 本地存储 → Token URL生成 → 用户下载
                                           ↓
                                      定期清理任务
```

### 4. 分析数据流程
```
用户行为 → 客户端事件 → GA4发送 → (同意后)匿名化分析
```

## 安全架构

### 认证授权
- **无需用户认证**：工具完全开放使用
- **API保护**：Rate limiting + CORS
- **资源访问**：签名URL控制文件访问

### 数据保护
- **传输加密**：反向代理强制HTTPS
- **存储安全**：临时文件定期清理
- **隐私保护**：客户端优先计算、最小数据收集

### 安全控制
- **CSP策略**：限制脚本来源
- **CORS配置**：API跨域控制  
- **Rate限制**：防止滥用
- **输入验证**：防止注入攻击

## 性能架构

### 页面性能
- **SSG优化**：预构建静态页面
- **代码分割**：按需加载
- **图片优化**：Next.js Image优化
- **字体优化**：预加载关键字体

### API性能
- **服务器端优化**：Next.js内置优化
- **缓存策略**：反向代理缓存 + 浏览器缓存
- **压缩传输**：Gzip/Brotli压缩（Nginx/Traefik）

### Core Web Vitals目标
| 指标 | 目标值 | 监控方式 |
|------|--------|----------|
| LCP | < 2.5s | Lighthouse CI + 本地性能测试 |
| FID | < 100ms | 简单的用户交互监控 |
| CLS | < 0.1 | 自动化测试 + 人工检查 |

## 可扩展性设计

### 水平扩展（后续）
- **负载均衡**：Coolify支持多实例部署
- **无状态设计**：Next.js API无状态计算
- **缓存策略**：浏览器缓存 + 反向代理缓存

### 垂直扩展
- **计算优化**：算法优化、并行计算
- **存储优化**：文件压缩、生命周期管理
- **网络优化**：HTTP/3、连接复用

## 监控与观测

### 性能监控（简化）
- **基础监控**：Coolify内置监控面板
- **健康检查**：Docker容器健康状态
- **日志监控**：容器日志分析

### 业务监控
- **使用分析**：GA4事件跟踪
- **转化漏斗**：计算完成率
- **用户行为**：热点功能分析

### 错误监控（简化）
- **错误跟踪**：Next.js内置错误处理 + 可选Sentry
- **日志分析**：Docker容器日志
- **告警机制**：Coolify基础告警 + 邮件通知

## 合规架构

### 数据合规
- **GDPR**：数据最小化、临时文件自动清理
- **隐私保护**：不存储用户个人数据
- **数据安全**：HTTPS传输、本地存储安全

### 技术合规
- **可访问性**：WCAG 2.1 AA级别
- **SEO合规**：结构化数据、语义化HTML
- **浏览器兼容**：现代浏览器支持

## 灾难恢复

### 备份策略（简化）
- **代码备份**：GitHub仓库
- **配置备份**：Coolify配置导出
- **数据备份**：临时文件无需备份（自动清理）

### 恢复策略（简化）
- **快速回滚**：Coolify部署历史回滚
- **容器重启**：自动故障恢复
- **监控告警**：Coolify告警通知

## 下一步演进

### 短期改进（3个月）
- [ ] 完善核心计算器功能
- [ ] 优化移动端体验
- [ ] 添加基础用户反馈
- [ ] 提升页面加载性能

### 中期改进（6个月）
- [ ] 增加更多统计工具
- [ ] 配置CDN加速（如需要）
- [ ] 实现离线PWA功能
- [ ] 多语言支持

### 长期愿景（1年）
- [ ] 用户数据导入导出增强
- [ ] 高级统计分析功能
- [ ] 可视化图表展示
- [ ] API开放给第三方集成

---

**文档维护**：本文档随架构演进定期更新，重大变更需要架构评审。